# Headscale 配置 - 生产优化版（修复 prefixes 和其他问题）
server_url: ${HEADSCALE_SERVER_URL:-http://127.0.0.1:8080}  # 会被环境变量 HEADSCALE_SERVER_URL 覆盖
listen_addr: 0.0.0.0:8080
grpc_listen_addr: 0.0.0.0:50443
grpc_allow_insecure: true  # Koyeb TLS 终止后允许明文 gRPC

# 必须添加：IP 前缀（至少一个 IPv4 或 IPv6，修复你的错误）
prefixes:
  v4: 192.168.100.0/24  # 默认 IPv4 范围（CGNAT）
  v6: fd12:3456:789a::/48  # 默认 IPv6 范围（ULA）
  allocation: sequential  # 分配策略：sequential 或 random

# 数据库 (SQLite 适合小型部署，修正 type 为 sqlite)
database:
  type: sqlite
  sqlite:
    path: /var/lib/headscale/db.sqlite

# Noise 协议密钥
noise:
  private_key_path: /var/lib/headscale/noise_private.key

# DNS 配置 (已修复 nameservers.global，添加 IPv6 支持)
dns:
  magic_dns: true
  base_domain: mytailnet.com  # 替换为你的自定义域名（如 mytailnet.com），必须有效 FQDN
  override_local_dns: true  # 覆盖客户端本地 DNS
  nameservers:
    global:
      - 1.1.1.1  # Cloudflare IPv4
      - 1.0.0.1  # Cloudflare IPv4 备选
      - 2606:4700:4700::1111  # Cloudflare IPv6
      - 2606:4700:4700::1001  # Cloudflare IPv6 备选
    split: {}  # 可选：特定域名用其他 DNS
  search_domains: []
  extra_records: []

# ACL Policy (默认允许所有)
policy:
  path: ""

# DERP 配置 (使用官方 DERP)
derp:
  urls:
    - https://controlplane.tailscale.com/derpmap/default

# TLS 配置 - 关闭内置TLS，让 Koyeb 处理
tls:
  letsencrypt_hostname: ""
  letsencrypt_cache_dir: ""
  cert_file: ""
  key_file: ""

# Log 配置
log:
  level: debug   # 可选: info, error, debug. 建议先用 debug
  format: text   # 可选: text, json. 建议用 text 方便肉眼看

# Prometheus 监控 (可选)
metrics_listen_addr: 127.0.0.1:9090

# 其他推荐字段（可选，但添加以完整性）
ephemeral_node_inactivity_timeout: 30m  # 节点不活跃超时
unix_socket: /var/run/headscale/headscale.sock  # CLI 管理 socket
unix_socket_permission: "0770"
logtail:
  enabled: false  # Tailscale 日志收集
randomize_client_port: false  # 客户端端口随机化

